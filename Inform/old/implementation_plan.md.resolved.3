# Enterprise Knowledge Base Website - Implementation Plan

## Goal Description
Deliver a secure, maintainable, on-prem enterprise knowledge-base platform unifying Training, Knowledge, Adoption, and Suggestion workflows under a single, role-controlled interface. The technology stack comprises Next.js 14, NestJS, and PostgreSQL 16, optimized for an AlmaLinux 9 environment with VAPT-oriented security in mind.

## Chosen Architectural Stack
We have locked in the following optimal choices based on the SOW requirements:
1. **Monorepo Tool**: **Turborepo**
2. **Database ORM**: **Prisma** 
3. **Authentication**: **Keycloak**

## Proposed Changes

### 1. Foundation & Monorepo
We will bootstrap a monorepo containing:
- `apps/frontend`: Next.js 14 (App Router) + React 19, initialized with Tailwind + shadcn/ui.
- `apps/backend`: NestJS (Node.js 20 LTS) modular backend.
- `packages/shared`: Shared TypeScript types/DTOs for contracts between frontend and backend.

### 2. Database Schema (PostgreSQL)
We will define the following core entities:
- `users`, `roles`, `user_roles`
- `sections`, `pages`, `modules`
- `menus`, `audit_logs`, `suggestions`

### 3. Core Modules Implementation
- **Authentication**: Implementing local admin login with bcrypt + JWT, and placeholders for external OIDC (Keycloak/Zitadel).
- **RBAC**: Implementing `@Roles()` decorators and `RolesGuard` in NestJS.
- **Content APIs**: Endpoints for Sections, Pages, and Modules with `dompurify` and secure file serving logic (`/api/files/:id`).

## Verification Plan

### Automated Tests
- Unit tests for NestJS API endpoints, especially RBAC guards.
- Static analysis and dependency checks (`npm audit`).

### Manual Verification
- Local deployment and testing of the application flow: Content creation by an admin -> RBAC filtering -> Rendering on Next.js frontend.
- Secure file download testing ensuring unauthorized users cannot access PDFs/Videos.

---

## Phase 5: Knowledge Bites Refinements
Based on the latest requirements, we will implement the following changes:

### 1. Schema Updates
- **Pages:** Add boolean flags `show_author` and `show_metrics` (default true) to control visibility of these details on the frontend.
- **Sections:** Add `parent_id` (String, nullable) to enable nested sub-sections.

### 2. Backend API
- Update Pages and Sections controllers/services to support the new schema fields.
- Ensure file upload handles robust video/PDF storage and returns accessible URLs for frontend previews.

### 3. Admin UI
- **Missing Pages:** Create fully functional pages for Users (`/admin/users`), Menus (`/admin/menus`), and Suggestions (`/admin/suggestions`).
- **Security Hub:** Create a placeholder interface explaining Active Directory integration steps (`/admin/security`).
- **Page Editor:** Add UI toggles for Author/Metrics visibility. Ensure the Status dropdown allows moving from "Archived" back to "Published".
- **Module Builder:** Replace text inputs with actual file browsing/uploading widgets (`<input type="file">`) when selecting PDF or Video module types.

### 4. Public UI
- **Rebranding:** Update all references of "Enterprise Knowledge Platform" to "Knowledge Bites".
- **Homepage Structure:** Center the Search Bar, and wire up the Hamburger Menu to dynamic Menu API data instead of hardcoded values.
- **Media Viewing:** Enhance the article view to display inline PDF Previews (via `<iframe>` or react-pdf) and ensure robust video playback controls.

---

## Phase 6: Admin Fixes & 2026 Tech Stack Upgrade
Based on client feedback, the platform will be upgraded to the latest 2026 LTS versions and several subtle administrative bugs will be fixed.

### 1. LTS Upgrades
- **Runtime:** Node.js 24.x (Active LTS) replacing 20.x in backend/frontend Dockerfiles.
- **Frontend Stack:** Upgrade Next.js to 16.x, React to 19.2.x, and Tailwind CSS to 4.2.x.
- **Backend Stack:** Upgrade NestJS to 11.x (from 10), TypeScript to 5.6.x, and latest bcrypt.
- **Database Layer:** Upgrade PostgreSQL from 16 to 18.x in `docker-compose.yml`, and Prisma to 7.4.x.
- **Deployment Layer:** Ensure PM2 5.4.x and nginx 1.28.x are targeted where applicable.

### 2. Admin Module Fixes
- **Prisma Foreign Key Errors:** When creating top-level Sections or Menus in the Admin UI, an empty string `""` is sent as `parent_id`. This causes Prisma UUID constraint failures. The frontend data payloads will be intercepted and coerced to `null` to ensure correct database storage.
- **Database Persistence for Suggestions:** The Suggestions portal is currently mocking state. We will implement the NestJS Controller and Service for `Suggestions`, routing requests to the Postgres DB so all information is properly stored in PostgreSQL, exactly as requested.
