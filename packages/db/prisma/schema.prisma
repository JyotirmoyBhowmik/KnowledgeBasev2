generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Auth & Users ────────────────────────────────────────

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  auth_source   String   @default("local")
  password_hash String?
  status        String   @default("active")
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  roles          UserRole[]
  audit_logs     AuditLog[]
  suggestions    Suggestion[]
  created_pages  Page[]        @relation("PageCreatedBy")
  updated_pages  Page[]        @relation("PageUpdatedBy")
  reviewed_pages Page[]        @relation("PageReviewedBy")
  page_versions  PageVersion[]
  activities     ActivityLog[]

  @@map("users")
}

model Role {
  id   String @id @default(uuid())
  name String @unique

  users UserRole[]

  @@map("roles")
}

model UserRole {
  user_id String
  role_id String

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
  @@map("user_roles")
}

// ─── Content Engine ──────────────────────────────────────

model Section {
  id            String   @id @default(uuid())
  parent_id     String?
  name          String
  slug          String   @unique
  route         String?
  roles_allowed Json?
  order         Int      @default(0)
  icon          String?
  visible       Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  parent   Section?  @relation("SectionHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children Section[] @relation("SectionHierarchy")
  pages    Page[]

  @@map("sections")
}

model Page {
  id             String    @id @default(uuid())
  section_id     String
  title          String
  slug           String    @unique
  status         String    @default("draft") // draft | review | published | archived
  show_author    Boolean   @default(true)
  show_metrics   Boolean   @default(true)
  icon           String?
  template_id    String?
  created_by_id  String?
  updated_by_id  String?
  reviewed_by_id String?
  reviewed_at    DateTime?
  deleted_at     DateTime? // soft-delete
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  section     Section       @relation(fields: [section_id], references: [id], onDelete: Cascade)
  created_by  User?         @relation("PageCreatedBy", fields: [created_by_id], references: [id], onDelete: SetNull)
  updated_by  User?         @relation("PageUpdatedBy", fields: [updated_by_id], references: [id], onDelete: SetNull)
  reviewed_by User?         @relation("PageReviewedBy", fields: [reviewed_by_id], references: [id], onDelete: SetNull)
  modules     Module[]
  versions    PageVersion[]

  @@map("pages")
}

model Module {
  id         String    @id @default(uuid())
  page_id    String
  type       String // TEXT | PDF | VIDEO | URL | IMAGE | TABLE | CODE | EMBED
  content    String? // rich HTML/Markdown for TEXT modules, code for CODE
  file_path  String? // for PDF, VIDEO, IMAGE
  url        String? // for URL modules
  title      String? // display title
  metadata   Json? // e.g. { language: "python" }, { headers: [...], rows: [...] }, { embedUrl: "..." }
  order      Int       @default(0)
  deleted_at DateTime? // soft-delete
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  page Page @relation(fields: [page_id], references: [id], onDelete: Cascade)

  @@map("modules")
}

// ─── Versioning ──────────────────────────────────────────

model PageVersion {
  id         String   @id @default(uuid())
  page_id    String
  version    Int
  snapshot   Json // full page + modules snapshot
  changed_by String?
  created_at DateTime @default(now())

  page Page  @relation(fields: [page_id], references: [id], onDelete: Cascade)
  user User? @relation(fields: [changed_by], references: [id], onDelete: SetNull)

  @@map("page_versions")
}

// ─── Templates ───────────────────────────────────────────

model PageTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  modules     Json // array of module skeletons
  created_at  DateTime @default(now())

  @@map("page_templates")
}

// ─── Activity Tracking ───────────────────────────────────

model ActivityLog {
  id          String   @id @default(uuid())
  user_id     String
  action      String // viewed | created | edited | deleted
  entity_type String
  entity_id   String
  details     String?
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

// ─── Audit & Suggestions ────────────────────────────────

model AuditLog {
  id          String   @id @default(uuid())
  user_id     String?
  action      String
  entity_type String
  entity_id   String
  before      Json?
  after       Json?
  created_at  DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

model Suggestion {
  id         String   @id @default(uuid())
  user_id    String?
  message    String
  status     String   @default("pending")
  created_at DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@map("suggestions")
}

// ─── Settings ────────────────────────────────────────────

model Setting {
  id         String   @id @default(uuid())
  key        String   @unique // e.g., 'site_brand_icon', 'favicon'
  value      String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("settings")
}
